<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <title>Web Scraper</title>
</head>
<body markdown=1>
  <form >
    <div class="mb-3">
      <input type="text" class="form-control" id="url" >
    </div>
    <div class="mb-3">
      <button type="button" class="btn btn-primary" id="get_consent">Get Content</button>
    </div>
  </form>
<style>
  .document-content{
    white-space: pre-wrap;
    word-break: break-all; 
  }
</style>
</body>
<script>
  var targetUrl = ''
document.getElementsByTagName('input')[0].addEventListener('input', (e) => {
  targetUrl = e.srcElement.value
})

 document.getElementsByTagName('button')[0].addEventListener('click',() => {
   getContent(targetUrl)
 })


 function getContent(url) {
  fetch('/api', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      type: 'markdown',
      url
    }) 
  })
  .then(response => response.body)
.then(rb => {
  console.log(rb)
  const reader = rb.getReader();

  return new ReadableStream({
    start(controller) {
      // The following function handles each data chunk
      function push() {
        // "done" is a Boolean and value a "Uint8Array"
        reader.read().then( ({done, value}) => {
          // If there is no more data to read
          if (done) {
            console.log('done', done);
            controller.close();
            return;
          }
          // Get the data and send it to the browser via the controller
          controller.enqueue(value);
          // Check chunks by logging to the console
          console.log(done, value);
          push();
        })
      }

      push();
    }
  });
})
.then(stream => {
  // Respond with our stream
  return new Response(stream, { headers: { "Content-Type": "text/html" } }).text();
})
.then(result => {
  // Do things with result
  try {
    document.getElementsByClassName('document-content')[0].remove()
  } finally {
    const p = document.createElement('div')
    p.classList.add('document-content')
    p.appendChild(document.createTextNode(result))
    document.getElementsByTagName('body')[0].appendChild(p)
    navigator.clipboard.writeText(result);
    // console.log(result);
  }
  });
}


</script>
</html>